{"changed":true,"filter":false,"title":"imageholder.c","tooltip":"/scorpion/vm/imageholder.c","value":" #include \"imgholder.h\"\n #include \"scorpionvm.h\"\n #include \"Opcodes.h\"\n #include \"Globals.h\"\n #include \"../clib/u4.h\"\n #include <sstream>\n #include <iostream>\n #include <string>\n using namespace std;\n\nextern long streamcount;\n double getb(){\n    long pos = gSvm.vm.vStaticRegs[VREG_PC]++;\n    \n    if(!(pos < streamcount))\n        return tok_eof;\n\n    return gSvm.bytestream[pos];\n }\n\n u4_d op_ags;\n \n void agsclear(){\n     op_ags.byte1 = 0;\n     op_ags.byte2 = 0;\n     op_ags.byte3 = 0;\n     op_ags.byte4 = 0;\n }\n\n static long CurByte;\n static int instrgroup = 5;\n stringstream word;\n long getByte(){\n     static long LastChar = ' ';\n     LastChar = getb();\n\n     if(LastChar == tok_eof)\n       return LastChar;\n     \n     if( !(LastChar > 0) && !(LastChar <= sMaxOpcodeLimit))\n        return tok_floating; // very bad\n        \n     agsclear();\n     if(LastChar == OP_NOP || LastChar == OP_END || LastChar == OP_HLT || LastChar == OP_NO || LastChar == OP_ENDNO){\n         instrgroup = 0;\n         return LastChar;\n     }\n     if(LastChar == OP_RETURN || LastChar == OP_PUSH || LastChar == OP_POP || LastChar == OP_JMP || LastChar == OP_CALL\n       || LastChar == OP_MTHD || LastChar == OP_LBL || LastChar == OP_IF || LastChar == OP_INC || LastChar == OP_DEC || LastChar == OP_SLP\n       || LastChar == OP_USLP){ // push 7 or push *x\n         instrgroup = 1;\n         op_ags.byte1 = getb();\n         return LastChar;\n     }\n     if(LastChar == OP_ICONST || LastChar == OP_DCONST || LastChar == OP_FCONST || \n        LastChar == OP_SCONST || LastChar == OP_BCONST || LastChar == OP_CCONST || LastChar == OP_RSHFT \n        || LastChar == OP_LSHFT || LastChar == OP_CIN || LastChar == OP_JIT \n        || LastChar == OP_JIF || LastChar == OP_THROW){ // mthd @9\n         instrgroup = 2;\n         op_ags.byte1 = getb();\n         op_ags.byte2 = getb();\n         return LastChar;\n     }\n     \n     if(LastChar == OP_ISEQ || LastChar == OP_ISNEQ || LastChar == OP_ISLT || LastChar == OP_ISNLT || LastChar == OP_ISLE || LastChar == OP_ISNLE\n       || LastChar == OP_ISGT || LastChar == OP_ISNGT || LastChar == OP_ISGE || LastChar == OP_ISNGE || LastChar == OP_IADD\n       || LastChar == OP_ISUB || LastChar == OP_IMULT || LastChar == OP_IDIV || LastChar == OP_SADD\n       || LastChar == OP_SSUB || LastChar == OP_SMULT || LastChar == OP_SDIV || LastChar == OP_DADD\n       || LastChar == OP_DSUB || LastChar == OP_DMULT || LastChar == OP_DDIV || LastChar == OP_FADD\n       || LastChar == OP_FSUB || LastChar == OP_FMULT || LastChar == OP_FDIV || LastChar == OP_CADD\n       || LastChar == OP_CSUB || LastChar == OP_CMULT || LastChar == OP_CDIV || LastChar == OP_IMOD\n       || LastChar == OP_CMOD || LastChar == OP_SMOD || LastChar == OP_OR || LastChar == OP_AND){ //\n         instrgroup = 3;\n         op_ags.byte1 = getb();\n         op_ags.byte2 = getb();\n         op_ags.byte3 = getb();\n         return LastChar;\n     }\n     \n     if(LastChar == OP_STRCONST || LastChar == OP_COUT){ // string 13 'Hello, World!'\n         instrgroup = 4;\n         op_ags.byte1 = getb();\n         char c;\n         word.str(\"\");\n         for(int i = 0; i < op_ags.byte1; i++){\n             c = (char) getb();\n             word << \"\" << c;\n         }\n         \n         return LastChar;\n     }\n     \n     instrgroup = 5;\n     return tok_floating; // it should never reach this point, still very bad\n }\n\n\nstring ImageHolder::getStr(){\n     return word.str();\n }\n\nu4_d ImageHolder::getAgs(){\n    return op_ags;\n}\n      \nlong ImageHolder::getOp(){\n    return CurByte;\n}\n\nint ImageHolder::getGroup(){\n   return instrgroup;\n}\n\n int ImageHolder::getNextInstr(){ //parse this alike the Compilr library\n     return CurByte = getByte();\n }\n \n \n \n","undoManager":{"mark":39,"position":100,"stack":[[{"start":{"row":48,"column":88},"end":{"row":48,"column":89},"action":"insert","lines":["O"],"id":544}],[{"start":{"row":48,"column":89},"end":{"row":48,"column":90},"action":"insert","lines":["P"],"id":545}],[{"start":{"row":48,"column":90},"end":{"row":48,"column":91},"action":"insert","lines":["_"],"id":546}],[{"start":{"row":48,"column":91},"end":{"row":48,"column":92},"action":"insert","lines":["I"],"id":547}],[{"start":{"row":48,"column":92},"end":{"row":48,"column":93},"action":"insert","lines":["N"],"id":548}],[{"start":{"row":48,"column":88},"end":{"row":48,"column":93},"action":"remove","lines":["OP_IN"],"id":549},{"start":{"row":48,"column":88},"end":{"row":48,"column":94},"action":"insert","lines":["OP_INC"]}],[{"start":{"row":48,"column":94},"end":{"row":48,"column":95},"action":"insert","lines":[" "],"id":550}],[{"start":{"row":48,"column":95},"end":{"row":48,"column":96},"action":"insert","lines":["|"],"id":551}],[{"start":{"row":48,"column":96},"end":{"row":48,"column":97},"action":"insert","lines":["|"],"id":552}],[{"start":{"row":48,"column":97},"end":{"row":48,"column":98},"action":"insert","lines":[" "],"id":553}],[{"start":{"row":48,"column":98},"end":{"row":48,"column":99},"action":"insert","lines":["L"],"id":554}],[{"start":{"row":48,"column":99},"end":{"row":48,"column":100},"action":"insert","lines":["a"],"id":555}],[{"start":{"row":48,"column":98},"end":{"row":48,"column":100},"action":"remove","lines":["La"],"id":556},{"start":{"row":48,"column":98},"end":{"row":48,"column":106},"action":"insert","lines":["LastChar"]}],[{"start":{"row":48,"column":106},"end":{"row":48,"column":107},"action":"insert","lines":[" "],"id":557}],[{"start":{"row":48,"column":107},"end":{"row":48,"column":108},"action":"insert","lines":["="],"id":558}],[{"start":{"row":48,"column":108},"end":{"row":48,"column":109},"action":"insert","lines":["="],"id":559}],[{"start":{"row":48,"column":109},"end":{"row":48,"column":110},"action":"insert","lines":[" "],"id":560}],[{"start":{"row":48,"column":110},"end":{"row":48,"column":111},"action":"insert","lines":["O"],"id":561}],[{"start":{"row":48,"column":111},"end":{"row":48,"column":112},"action":"insert","lines":["P"],"id":562}],[{"start":{"row":48,"column":112},"end":{"row":48,"column":113},"action":"insert","lines":["_"],"id":563}],[{"start":{"row":48,"column":113},"end":{"row":48,"column":114},"action":"insert","lines":["D"],"id":564}],[{"start":{"row":48,"column":114},"end":{"row":48,"column":115},"action":"insert","lines":["E"],"id":565}],[{"start":{"row":48,"column":110},"end":{"row":48,"column":115},"action":"remove","lines":["OP_DE"],"id":566},{"start":{"row":48,"column":110},"end":{"row":48,"column":116},"action":"insert","lines":["OP_DEC"]}],[{"start":{"row":70,"column":73},"end":{"row":70,"column":74},"action":"insert","lines":[" "],"id":567}],[{"start":{"row":70,"column":74},"end":{"row":70,"column":75},"action":"insert","lines":["|"],"id":568}],[{"start":{"row":70,"column":75},"end":{"row":70,"column":76},"action":"insert","lines":["|"],"id":569}],[{"start":{"row":70,"column":76},"end":{"row":70,"column":77},"action":"insert","lines":[" "],"id":570}],[{"start":{"row":70,"column":77},"end":{"row":70,"column":78},"action":"insert","lines":["L"],"id":571}],[{"start":{"row":70,"column":78},"end":{"row":70,"column":79},"action":"insert","lines":["a"],"id":572}],[{"start":{"row":70,"column":77},"end":{"row":70,"column":79},"action":"remove","lines":["La"],"id":573},{"start":{"row":70,"column":77},"end":{"row":70,"column":85},"action":"insert","lines":["LastChar"]}],[{"start":{"row":70,"column":85},"end":{"row":70,"column":86},"action":"insert","lines":[" "],"id":574}],[{"start":{"row":70,"column":86},"end":{"row":70,"column":87},"action":"insert","lines":["="],"id":575}],[{"start":{"row":70,"column":87},"end":{"row":70,"column":88},"action":"insert","lines":["="],"id":576}],[{"start":{"row":70,"column":88},"end":{"row":70,"column":89},"action":"insert","lines":[" "],"id":577}],[{"start":{"row":70,"column":89},"end":{"row":70,"column":90},"action":"insert","lines":["O"],"id":578}],[{"start":{"row":70,"column":90},"end":{"row":70,"column":91},"action":"insert","lines":["P"],"id":579}],[{"start":{"row":70,"column":91},"end":{"row":70,"column":92},"action":"insert","lines":["_"],"id":580}],[{"start":{"row":70,"column":92},"end":{"row":70,"column":93},"action":"insert","lines":["A"],"id":581}],[{"start":{"row":70,"column":93},"end":{"row":70,"column":94},"action":"insert","lines":["N"],"id":582}],[{"start":{"row":70,"column":89},"end":{"row":70,"column":94},"action":"remove","lines":["OP_AN"],"id":583},{"start":{"row":70,"column":89},"end":{"row":70,"column":95},"action":"insert","lines":["OP_AND"]}],[{"start":{"row":48,"column":116},"end":{"row":48,"column":117},"action":"insert","lines":[" "],"id":584}],[{"start":{"row":48,"column":117},"end":{"row":48,"column":118},"action":"insert","lines":["|"],"id":585}],[{"start":{"row":48,"column":118},"end":{"row":48,"column":119},"action":"insert","lines":["|"],"id":586}],[{"start":{"row":48,"column":119},"end":{"row":48,"column":120},"action":"insert","lines":[" "],"id":587}],[{"start":{"row":48,"column":120},"end":{"row":48,"column":121},"action":"insert","lines":["L"],"id":588}],[{"start":{"row":48,"column":121},"end":{"row":48,"column":122},"action":"insert","lines":["a"],"id":589}],[{"start":{"row":48,"column":120},"end":{"row":48,"column":122},"action":"remove","lines":["La"],"id":590},{"start":{"row":48,"column":120},"end":{"row":48,"column":128},"action":"insert","lines":["LastChar"]}],[{"start":{"row":48,"column":128},"end":{"row":48,"column":129},"action":"insert","lines":[" "],"id":591}],[{"start":{"row":48,"column":129},"end":{"row":48,"column":130},"action":"insert","lines":["="],"id":592}],[{"start":{"row":48,"column":130},"end":{"row":48,"column":131},"action":"insert","lines":["="],"id":593}],[{"start":{"row":48,"column":131},"end":{"row":48,"column":132},"action":"insert","lines":[" "],"id":594}],[{"start":{"row":48,"column":132},"end":{"row":48,"column":133},"action":"insert","lines":["O"],"id":595}],[{"start":{"row":48,"column":133},"end":{"row":48,"column":134},"action":"insert","lines":["P"],"id":596}],[{"start":{"row":48,"column":134},"end":{"row":48,"column":135},"action":"insert","lines":["-"],"id":597}],[{"start":{"row":48,"column":134},"end":{"row":48,"column":135},"action":"remove","lines":["-"],"id":598}],[{"start":{"row":48,"column":134},"end":{"row":48,"column":135},"action":"insert","lines":["_"],"id":599}],[{"start":{"row":48,"column":135},"end":{"row":48,"column":136},"action":"insert","lines":["O"],"id":600}],[{"start":{"row":48,"column":135},"end":{"row":48,"column":136},"action":"remove","lines":["O"],"id":601}],[{"start":{"row":48,"column":135},"end":{"row":48,"column":136},"action":"insert","lines":["S"],"id":602}],[{"start":{"row":48,"column":136},"end":{"row":48,"column":137},"action":"insert","lines":["L"],"id":603}],[{"start":{"row":48,"column":132},"end":{"row":48,"column":137},"action":"remove","lines":["OP_SL"],"id":604},{"start":{"row":48,"column":132},"end":{"row":48,"column":138},"action":"insert","lines":["OP_SLP"]}],[{"start":{"row":48,"column":138},"end":{"row":49,"column":0},"action":"insert","lines":["",""],"id":605},{"start":{"row":49,"column":0},"end":{"row":49,"column":7},"action":"insert","lines":["       "]}],[{"start":{"row":49,"column":7},"end":{"row":49,"column":8},"action":"insert","lines":["}"],"id":606}],[{"start":{"row":49,"column":7},"end":{"row":49,"column":8},"action":"remove","lines":["}"],"id":607}],[{"start":{"row":49,"column":7},"end":{"row":49,"column":8},"action":"insert","lines":["|"],"id":608}],[{"start":{"row":49,"column":8},"end":{"row":49,"column":9},"action":"insert","lines":["|"],"id":609}],[{"start":{"row":49,"column":9},"end":{"row":49,"column":10},"action":"insert","lines":[" "],"id":610}],[{"start":{"row":49,"column":10},"end":{"row":49,"column":11},"action":"insert","lines":["L"],"id":611}],[{"start":{"row":49,"column":11},"end":{"row":49,"column":12},"action":"insert","lines":["a"],"id":612}],[{"start":{"row":49,"column":10},"end":{"row":49,"column":12},"action":"remove","lines":["La"],"id":613},{"start":{"row":49,"column":10},"end":{"row":49,"column":18},"action":"insert","lines":["LastChar"]}],[{"start":{"row":49,"column":18},"end":{"row":49,"column":19},"action":"insert","lines":[" "],"id":614}],[{"start":{"row":49,"column":19},"end":{"row":49,"column":20},"action":"insert","lines":["="],"id":615}],[{"start":{"row":49,"column":20},"end":{"row":49,"column":21},"action":"insert","lines":["="],"id":616}],[{"start":{"row":49,"column":21},"end":{"row":49,"column":22},"action":"insert","lines":[" "],"id":617}],[{"start":{"row":49,"column":22},"end":{"row":49,"column":23},"action":"insert","lines":["U"],"id":618}],[{"start":{"row":49,"column":22},"end":{"row":49,"column":23},"action":"remove","lines":["U"],"id":619}],[{"start":{"row":49,"column":22},"end":{"row":49,"column":23},"action":"insert","lines":["O"],"id":620}],[{"start":{"row":49,"column":23},"end":{"row":49,"column":24},"action":"insert","lines":["P"],"id":621}],[{"start":{"row":49,"column":24},"end":{"row":49,"column":25},"action":"insert","lines":["_"],"id":622}],[{"start":{"row":49,"column":25},"end":{"row":49,"column":26},"action":"insert","lines":["U"],"id":623}],[{"start":{"row":49,"column":26},"end":{"row":49,"column":27},"action":"insert","lines":["S"],"id":624}],[{"start":{"row":49,"column":27},"end":{"row":49,"column":28},"action":"insert","lines":["L"],"id":625}],[{"start":{"row":49,"column":22},"end":{"row":49,"column":28},"action":"remove","lines":["OP_USL"],"id":626},{"start":{"row":49,"column":22},"end":{"row":49,"column":29},"action":"insert","lines":["OP_USLP"]}],[{"start":{"row":57,"column":29},"end":{"row":57,"column":30},"action":"insert","lines":[" "],"id":627}],[{"start":{"row":57,"column":30},"end":{"row":57,"column":31},"action":"insert","lines":["|"],"id":628}],[{"start":{"row":57,"column":31},"end":{"row":57,"column":32},"action":"insert","lines":["|"],"id":629}],[{"start":{"row":57,"column":32},"end":{"row":57,"column":33},"action":"insert","lines":[" "],"id":630}],[{"start":{"row":57,"column":33},"end":{"row":57,"column":34},"action":"insert","lines":["L"],"id":631}],[{"start":{"row":57,"column":34},"end":{"row":57,"column":35},"action":"insert","lines":["a"],"id":632}],[{"start":{"row":57,"column":35},"end":{"row":57,"column":36},"action":"insert","lines":["s"],"id":633}],[{"start":{"row":57,"column":33},"end":{"row":57,"column":36},"action":"remove","lines":["Las"],"id":634},{"start":{"row":57,"column":33},"end":{"row":57,"column":41},"action":"insert","lines":["LastChar"]}],[{"start":{"row":57,"column":41},"end":{"row":57,"column":42},"action":"insert","lines":[" "],"id":635}],[{"start":{"row":57,"column":42},"end":{"row":57,"column":43},"action":"insert","lines":["="],"id":636}],[{"start":{"row":57,"column":43},"end":{"row":57,"column":44},"action":"insert","lines":["="],"id":637}],[{"start":{"row":57,"column":44},"end":{"row":57,"column":45},"action":"insert","lines":[" "],"id":638}],[{"start":{"row":57,"column":45},"end":{"row":57,"column":46},"action":"insert","lines":["O"],"id":639}],[{"start":{"row":57,"column":46},"end":{"row":57,"column":47},"action":"insert","lines":["P"],"id":640}],[{"start":{"row":57,"column":47},"end":{"row":57,"column":48},"action":"insert","lines":["_"],"id":641}],[{"start":{"row":57,"column":48},"end":{"row":57,"column":49},"action":"insert","lines":["T"],"id":642}],[{"start":{"row":57,"column":49},"end":{"row":57,"column":50},"action":"insert","lines":["H"],"id":643}],[{"start":{"row":57,"column":45},"end":{"row":57,"column":50},"action":"remove","lines":["OP_TH"],"id":644},{"start":{"row":57,"column":45},"end":{"row":57,"column":53},"action":"insert","lines":["OP_THROW"]}]]},"ace":{"folds":[],"scrolltop":704.4444631058498,"scrollleft":0,"selection":{"start":{"row":57,"column":53},"end":{"row":57,"column":53},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":370,"mode":"ace/mode/c_cpp"}},"timestamp":1444545048754}