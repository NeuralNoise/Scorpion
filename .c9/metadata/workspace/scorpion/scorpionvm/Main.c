{"changed":true,"filter":false,"title":"Main.c","tooltip":"/scorpion/scorpionvm/Main.c","value":"/*\n * Copyright (C) 2015 The Scorpion Programming Language\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n *\n * Portions of the code surrounded by \"// Begin Dalvik code\" and\n * \"// END Delvik code\" are copyrighted and licensed separately, as\n * follows:\n *\n * Copyright (C) 2014 The Android Open Source Project\n *\n * Licensed to the Apache Software Foundation (ASF) under one or more\n * contributor license agreements. The ASF licenses this file to You\n * under the Apache License, Version 2.0 (the \"License\"); you may not use \n * this file except in compliance with the License.  You may obtain a copy\n * of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n *\n */\n /*\n * Command line invocation of the Scorpion VM\n */\n \n #include \"../vm/scorpionvm.h\" \n #include \"../vm/exception.h\"\n #include \"../vm/scorpion_env.h\"\n #include \"../logservice/alog.h\"\n #include \"../logservice/filter.h\"\n #include \"../vm/Globals.h\"\n #include <sys/types.h>\n #include <sys/stat.h>\n #include <stdlib.h>\n #include <stdio.h>\n #include <string.h>\n #include \"../libxso/xso.h\"\n #include <signal.h>\n #include <assert.h>\n #include <iostream>\n #include <sstream>\n \n using namespace std;\n \nvoid printusage()\n{\n  string product_website = \"https://github.com/AndroDevcd/Scorpion/wiki\";\n  \n  printf(\"Usage scorpion [-options] xso [args...]\\n\");    \n  printf(\"           (to execute scorpion object file)\\n\");\n  printf(\"or    scorpion [-options] -sar sarfile [args...]\\n\");\n  printf(\"           (to execute a sar file)\\n\\n\");\n  printf(\"   -version        print the current product version and exit.\\n\");\n  printf(\"   -showversion    print the current product version and continue.\\n\");\n  printf(\"   -help -?        display this help screen.\\n\");\n  printf(\"   -da -disableassertions\\n\");\n  printf(\"                   disable assertions.\\n\");\n  printf(\"   -Xms <size>     set the minimum heap size.\\n\");\n  printf(\"   -Xmx <size>     set the max heap size.\\n\");\n  printf(\"   -sdb            enable the scorpion debug bridge.\\n\");\n  printf(\"   -?std           print non-standard options.\\n\");\n  printf(\"See %s for more details.\\n\", product_website.c_str());\n}\n\n#define nullptr ((void *)0)\n\nALog alog;\nextern int vmStatus;\n\nSvmGlobals gSvm;\n\n/*\n* Parse arguments.  Most of it just gets passed through to the VM.\n*\n* Look at the log! The Scorpion Virtual Machine offers a \n* comprehensive logging system that will tell you everything \n* you need to know when debugging a Scorpion application.\n*\n* System log dest: /us/share/scorpion/vm/log/out.log\n*/\nint main(int argc, const char **argv){\n    ScorpionVM vm;\n    ScorpionEnv* p_env = NULL;\n    XSO* x = NULL;\n    int optionCount, curOpt, i, argIdx;\n    int needExtra = 0;\n    int result = 1;\n    int status;\n    std::string lastFlag;\n    string problemFlag;\n\n    if(argc == 1){\n       printusage();\n       goto bail;\n    }\n\n    /*\n     * If we're adding any additional stuff, e.g. function hook specifiers,\n     * add them to the count here.\n     *\n     * We're over-allocating, becforause this includes the options to the VM\n     * plus the options to the program.\n     */\n    optionCount = argc - 1;\n    Exception::trace.addproto(\"vm.internal.system.main\", \"[ScorpionVirtualMachine]\", 1);\n\n    // Setup VM and compiler directories\n    status = system(\"sudo mkdir -p /usr/share/scorpion/lib\");\n    status = system(\"sudo mkdir -p /usr/share/scorpion/vm/log\");\n\n    /* Setup Logging Service */\n    alog.setup(7);\n    alog.setClass(\"ALog\");\n    alog.ALOGI(\"Log setup: using /usr/scorpion/vm/log\");\n\n    /*\n     * First level Arg check.  Check if argumets arent faulty\n     * all arguments begin with a '-'\n     *\n     * VM Options:\n     *\n     * Usage scorpion [-options] xso [args...]\n     *            (to execute scorpion object file)\n     * or    scorpion [-options] -sar sarfile [args...]\n     *            (to execute a sar file)\n     *\n     *    -version\n     *    -showversion\n     *    -help -? \n     *    -da(disable assertions)\n     *    -Xms <size>\n     *    -Xmx <size>\n     *    -sdb\n     * [Do we need to catch & handle \"-sar\" here?]\n     */\n    curOpt = 0;\n    needExtra = 0;\n    for (argIdx = 1; argIdx < argc; argIdx++) {\n        lastFlag = argv[argIdx];\n\n        /* some options require an additional arg */\n        if ((lastFlag == \"-Xms\") ||\n            (lastFlag == \"-Xmx\"))\n            /* others? */\n        {\n            if(!((argIdx + 1) < argc)){\n                problemFlag = lastFlag;\n                needExtra = 1;\n                break;\n            }\n            \n            string s = argv[argIdx + 1];\n            if(s.at(0) == '-'){\n                problemFlag = lastFlag;\n                needExtra = 1;\n            }\n        }\n    }\n\n    \n    if (needExtra != 0) {\n        printf(\"error:  Faulty Argument flag. Scorpion VM requires a value after option flag: %s\\n\", problemFlag.c_str());\n        goto bail;\n    }\n\n    /*\n     * Start VM.  The current thread becomes the main thread of the VM.\n     */\n     Init_CreateScorpionVM(vm, p_env, x, argv, argc);\n\n\n    if(vmStatus != 0) { // have method return ScorpionEnv\n        printf(\"error:  Failed to initalize the Scorpion VM.\\nA fatal error has occured, shutting down.\\n\");\n        goto bail;\n    }\n\n    gSvm.vm.status = 1; // Virtual machine has been created\n    x = NULL;\n\n    /* We Skip creating the Main Thread */\n\n    /* Start Virtual Machine */\n    status = Init_StartScorpionVM();\n\n    if (status != 0)\n        alog.ALOGW(\"Failed to start the Scorpion Virtual Machine.\");\n\n\n\n    /*\n    * Shut down the Scorpion Virtual Machine due to\n    * boot err.\n    */\n    bail:\n        /*printf(\"Shutting down Dalvik VM\\n\");*/\n     if (gSvm.vm.status != 0) \n        Init_ShutdownScorpionVM();\n    \n      alog.ALOGV(\"--- VM is down, process exiting.\");\n      return result;\n}\n\n","undoManager":{"mark":8,"position":10,"stack":[[{"start":{"row":42,"column":32},"end":{"row":43,"column":36},"action":"remove","lines":[""," #include \"../vm/alloc/BlockTable.h\""],"id":70}],[{"start":{"row":85,"column":0},"end":{"row":86,"column":0},"action":"insert","lines":["",""],"id":71}],[{"start":{"row":86,"column":0},"end":{"row":87,"column":0},"action":"insert","lines":["",""],"id":72}],[{"start":{"row":86,"column":0},"end":{"row":86,"column":1},"action":"insert","lines":["#"],"id":73}],[{"start":{"row":86,"column":1},"end":{"row":86,"column":2},"action":"insert","lines":["d"],"id":74}],[{"start":{"row":86,"column":2},"end":{"row":86,"column":3},"action":"insert","lines":["e"],"id":75}],[{"start":{"row":86,"column":1},"end":{"row":86,"column":3},"action":"remove","lines":["de"],"id":76},{"start":{"row":86,"column":1},"end":{"row":86,"column":7},"action":"insert","lines":["define"]}],[{"start":{"row":86,"column":7},"end":{"row":86,"column":8},"action":"insert","lines":[" "],"id":77}],[{"start":{"row":86,"column":8},"end":{"row":86,"column":28},"action":"insert","lines":["SCORPION_DEVELOPMENT"],"id":78}],[{"start":{"row":85,"column":0},"end":{"row":86,"column":28},"action":"remove","lines":["","#define SCORPION_DEVELOPMENT"],"id":79}],[{"start":{"row":84,"column":16},"end":{"row":85,"column":0},"action":"remove","lines":["",""],"id":80}]]},"ace":{"folds":[],"scrolltop":1451,"scrollleft":0,"selection":{"start":{"row":84,"column":16},"end":{"row":84,"column":16},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":42,"state":"start","mode":"ace/mode/c_cpp"}},"timestamp":1445361365980}