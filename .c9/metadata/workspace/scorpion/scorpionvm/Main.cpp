{"changed":true,"filter":false,"title":"Main.cpp","tooltip":"/scorpion/scorpionvm/Main.cpp","value":"/*\n * Copyright (C) <year> The Scorpion Programming Language\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n *\n * Portions of the code surrounded by \"// Begin Dalvik code\" and\n * \"// END Delvik code\" are copyrighted and licensed separately, as\n * follows:\n *\n * Copyright (C) <year> The Android Open Source Project\n *\n * Licensed to the Apache Software Foundation (ASF) under one or more\n * contributor license agreements. The ASF licenses this file to You\n * under the Apache License, Version 2.0 (the \"License\"); you may not use \n * this file except in compliance with the License.  You may obtain a copy\n * of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n *\n */\n /*\n * Command line invocation of the Scorpion VM\n */\n \n #include \"../vm/scorpionvm.h\" \n #include <stdlib.h>\n #include <stdio.h>\n #include <string.h>\n #include <signal.h>\n #include <assert.h>\n #include <iostream>\n \n using namespace std;\n \n \nvoid printusage()\n{\n  string product_website = \"https://github.com/AndroDevcd/Scorpion/wiki\";\n  \n  printf(\"Usage scorpion [-options] xso [args...]\\n\");    \n  printf(\"           (to execute scorpion object file)\\n\");\n  printf(\"or    scorpion [-options] -sar sarfile [args...]\\n\");\n  printf(\"           (to execute a sar file)\\n\\n\");\n  printf(\"   -version        print the current product version and exit.\\n\");\n  printf(\"   -showversion    print the current product version and continue.\\n\");\n  printf(\"   -help -?        display this help screen.\\n\");\n  printf(\"   -da -disableassertions\\n\");\n  printf(\"                   disable assertions.\\n\");\n  printf(\"   -Xms <size>     set the minimum heap size.\\n\");\n  printf(\"   -Xmx <size>     set the max heap size.\\n\");\n  printf(\"   -sdb            enable the scorpion debug bridge.\\n\");\n  printf(\"   -virtual        extend memory to virtual computing(slows down performance).\\n\");\n  printf(\"See %s for more details.\\n\", product_website.c_str());\n}\n\n\n/*\n* Parse arguments.  Most of it just gets passed through to the VM.\n*/\nint main(int argc, const char **argv){\n    ScorpionVM* vm = NULL;\n    string* args = NULL;\n    int optionCount, curOpt, i, argIdx;\n    int needExtra = 0;\n    int result = 1;\n    std::string lastFlag;\n    \n    if(argc == 1){\n       printusage();\n       goto bail;\n    }\n    \n    /*\n     * If we're adding any additional stuff, e.g. function hook specifiers,\n     * add them to the count here.\n     *\n     * We're over-allocating, because this includes the options to the VM\n     * plus the options to the program.\n     */\n    optionCount = argc - 1;\n    args = new string[optionCount];\n    \n    /*\n     * Copy options over.  Everything up to the name of the class starts\n     * with a '-'\n     *\n     * VM Options:\n     *\n     * Usage scorpion [-options] xso [args...]\n     *            (to execute scorpion object file)\n     * or    scorpion [-options] -sar sarfile [args...]\n     *            (to execute a sar file)\n     *\n     *    -version\n     *    -showversion\n     *    -help -? \n     *    -da(disable assertions)\n     *    -Xms <size>\n     *    -Xmx <size>\n     *    -sdb\n     *    -virtual(extend memory to virtual computing[slows down performance])\n     * [Do we need to catch & handle \"-sar\" here?]\n     */\n    curOpt = 0;\n    needExtra = 0;\n    for (argIdx = 1; argIdx < argc; argIdx++) {\n        lastFlag = argv[argIdx];\n            \n        args[curOpt++] = lastFlag;\n\n        /* some options require an additional arg */\n        if ((lastFlag == \"-Xms\") ||\n            (lastFlag == \"-Xmx\"))\n            /* others? */\n        {\n            if(!((argIdx + 1) < argc)){\n                needExtra = 1;\n                break;\n            }\n            \n            string s = argv[argIdx + 1];\n            if(s.at(0) == '-')\n               needExtra = 1;\n        }\n    }\n\n    \n    if (needExtra != 0) {\n        printf(\"Scorpion VM requires value after last option flag: %s\\n\", lastFlag.c_str());\n        goto bail;\n    }\n    \n       \n        /*\n     * Start VM.  The current thread becomes the main thread of the VM.\n     */\n    if (Init_CreateScorpionVM(vm, args) != 0) {\n        printf(\"Scorpion VM init failed (check log file)\\n\");\n        goto bail;\n    }\n       \n    \n    /*\n    * Shut down the Scorpion Virtual Machine due to\n    * boot err.\n    */\n    bail:\n        /*printf(\"Shutting down Dalvik VM\\n\");*/\n    if (vm != NULL) {\n        /*\n         * This allows join() and isAlive() on the main thread to work\n         * correctly, and also provides uncaught exception handling.\n         */\n     //   if ((*vm)->DetachCurrentThread(vm) != JNI_OK) {\n    //        fprintf(stderr, \"Warning: unable to detach main thread\\n\");\n    //        result = 1;\n     //   }\n\n    //    if ((*vm)->DestroyJavaVM(vm) != 0)\n    //        fprintf(stderr, \"Warning: Dalvik VM did not shut down cleanly\\n\");\n        /*printf(\"\\nDalvik VM has exited\\n\");*/\n    }\n    \n      delete[] args;\n      delete[] vm;\n      printf(\"--- VM is down, process exiting\\n\");\n      return result;\n}\n","undoManager":{"mark":89,"position":100,"stack":[[{"start":{"row":149,"column":7},"end":{"row":155,"column":5},"action":"insert","lines":[" /*","     * Start VM.  The current thread becomes the main thread of the VM.","     */","    if (JNI_CreateJavaVM(&vm, &env, &initArgs) < 0) {","        fprintf(stderr, \"Dalvik VM init failed (check log file)\\n\");","        goto bail;","    }"],"id":3005}],[{"start":{"row":152,"column":29},"end":{"row":152,"column":35},"action":"remove","lines":[" &env,"],"id":3006}],[{"start":{"row":152,"column":31},"end":{"row":152,"column":36},"action":"remove","lines":["initA"],"id":3007},{"start":{"row":152,"column":31},"end":{"row":152,"column":32},"action":"insert","lines":["a"]}],[{"start":{"row":152,"column":8},"end":{"row":152,"column":11},"action":"remove","lines":["JNI"],"id":3008},{"start":{"row":152,"column":8},"end":{"row":152,"column":9},"action":"insert","lines":["I"]}],[{"start":{"row":152,"column":9},"end":{"row":152,"column":10},"action":"insert","lines":["n"],"id":3009}],[{"start":{"row":152,"column":10},"end":{"row":152,"column":11},"action":"insert","lines":["i"],"id":3010}],[{"start":{"row":152,"column":11},"end":{"row":152,"column":12},"action":"insert","lines":["t"],"id":3011}],[{"start":{"row":152,"column":19},"end":{"row":152,"column":23},"action":"remove","lines":["Java"],"id":3012},{"start":{"row":152,"column":19},"end":{"row":152,"column":20},"action":"insert","lines":["S"]}],[{"start":{"row":152,"column":20},"end":{"row":152,"column":21},"action":"insert","lines":["c"],"id":3013}],[{"start":{"row":152,"column":21},"end":{"row":152,"column":22},"action":"insert","lines":["o"],"id":3014}],[{"start":{"row":152,"column":22},"end":{"row":152,"column":23},"action":"insert","lines":["r"],"id":3015}],[{"start":{"row":152,"column":23},"end":{"row":152,"column":24},"action":"insert","lines":["p"],"id":3016}],[{"start":{"row":152,"column":24},"end":{"row":152,"column":25},"action":"insert","lines":["i"],"id":3017}],[{"start":{"row":152,"column":25},"end":{"row":152,"column":26},"action":"insert","lines":["o"],"id":3018}],[{"start":{"row":152,"column":26},"end":{"row":152,"column":27},"action":"insert","lines":["n"],"id":3019}],[{"start":{"row":153,"column":8},"end":{"row":153,"column":9},"action":"remove","lines":["f"],"id":3020}],[{"start":{"row":153,"column":22},"end":{"row":153,"column":23},"action":"remove","lines":[" "],"id":3021}],[{"start":{"row":153,"column":21},"end":{"row":153,"column":22},"action":"remove","lines":[","],"id":3022}],[{"start":{"row":153,"column":20},"end":{"row":153,"column":21},"action":"remove","lines":["r"],"id":3023}],[{"start":{"row":153,"column":19},"end":{"row":153,"column":20},"action":"remove","lines":["r"],"id":3024}],[{"start":{"row":153,"column":18},"end":{"row":153,"column":19},"action":"remove","lines":["e"],"id":3025}],[{"start":{"row":153,"column":17},"end":{"row":153,"column":18},"action":"remove","lines":["d"],"id":3026}],[{"start":{"row":153,"column":16},"end":{"row":153,"column":17},"action":"remove","lines":["t"],"id":3027}],[{"start":{"row":153,"column":15},"end":{"row":153,"column":16},"action":"remove","lines":["s"],"id":3028}],[{"start":{"row":167,"column":8},"end":{"row":168,"column":22},"action":"remove","lines":["result = -1;","        return result;"],"id":3029},{"start":{"row":167,"column":8},"end":{"row":181,"column":5},"action":"insert","lines":["/*printf(\"Shutting down Dalvik VM\\n\");*/","    if (vm != NULL) {","        /*","         * This allows join() and isAlive() on the main thread to work","         * correctly, and also provides uncaught exception handling.","         */","        if ((*vm)->DetachCurrentThread(vm) != JNI_OK) {","            fprintf(stderr, \"Warning: unable to detach main thread\\n\");","            result = 1;","        }","","        if ((*vm)->DestroyJavaVM(vm) != 0)","            fprintf(stderr, \"Warning: Dalvik VM did not shut down cleanly\\n\");","        /*printf(\"\\nDalvik VM has exited\\n\");*/","    }"]}],[{"start":{"row":157,"column":3},"end":{"row":160,"column":18},"action":"remove","lines":[" delete[] args;","    delete[] vm;","    printf(\"--- VM is down, process exiting\\n\");","    return result;"],"id":3031}],[{"start":{"row":157,"column":2},"end":{"row":157,"column":3},"action":"remove","lines":[" "],"id":3032}],[{"start":{"row":157,"column":1},"end":{"row":157,"column":2},"action":"remove","lines":[" "],"id":3033}],[{"start":{"row":157,"column":0},"end":{"row":157,"column":1},"action":"remove","lines":[" "],"id":3034}],[{"start":{"row":156,"column":7},"end":{"row":157,"column":0},"action":"remove","lines":["",""],"id":3035}],[{"start":{"row":177,"column":5},"end":{"row":178,"column":0},"action":"insert","lines":["",""],"id":3036},{"start":{"row":178,"column":0},"end":{"row":178,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":178,"column":4},"end":{"row":179,"column":0},"action":"insert","lines":["",""],"id":3037},{"start":{"row":179,"column":0},"end":{"row":179,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":179,"column":4},"end":{"row":182,"column":18},"action":"insert","lines":[" delete[] args;","    delete[] vm;","    printf(\"--- VM is down, process exiting\\n\");","    return result;"],"id":3038}],[{"start":{"row":179,"column":4},"end":{"row":179,"column":5},"action":"remove","lines":[" "],"id":3039}],[{"start":{"row":179,"column":4},"end":{"row":179,"column":5},"action":"insert","lines":[" "],"id":3040}],[{"start":{"row":179,"column":5},"end":{"row":179,"column":6},"action":"insert","lines":[" "],"id":3041}],[{"start":{"row":180,"column":4},"end":{"row":180,"column":5},"action":"insert","lines":[" "],"id":3042}],[{"start":{"row":180,"column":5},"end":{"row":180,"column":6},"action":"insert","lines":[" "],"id":3043}],[{"start":{"row":181,"column":4},"end":{"row":181,"column":5},"action":"insert","lines":[" "],"id":3044}],[{"start":{"row":181,"column":5},"end":{"row":181,"column":6},"action":"insert","lines":[" "],"id":3045}],[{"start":{"row":182,"column":4},"end":{"row":182,"column":5},"action":"insert","lines":[" "],"id":3046}],[{"start":{"row":182,"column":5},"end":{"row":182,"column":6},"action":"insert","lines":[" "],"id":3047}],[{"start":{"row":152,"column":3},"end":{"row":152,"column":4},"action":"insert","lines":["/"],"id":3048}],[{"start":{"row":152,"column":4},"end":{"row":152,"column":5},"action":"insert","lines":["/"],"id":3049}],[{"start":{"row":153,"column":3},"end":{"row":153,"column":4},"action":"insert","lines":["/"],"id":3050}],[{"start":{"row":153,"column":4},"end":{"row":153,"column":5},"action":"insert","lines":["/"],"id":3051}],[{"start":{"row":154,"column":2},"end":{"row":154,"column":3},"action":"insert","lines":["/"],"id":3052}],[{"start":{"row":154,"column":3},"end":{"row":154,"column":4},"action":"insert","lines":["/"],"id":3053}],[{"start":{"row":155,"column":2},"end":{"row":155,"column":3},"action":"insert","lines":["/"],"id":3054}],[{"start":{"row":155,"column":3},"end":{"row":155,"column":4},"action":"insert","lines":["/"],"id":3055}],[{"start":{"row":169,"column":5},"end":{"row":169,"column":6},"action":"insert","lines":["/"],"id":3056}],[{"start":{"row":169,"column":6},"end":{"row":169,"column":7},"action":"insert","lines":["/"],"id":3057}],[{"start":{"row":170,"column":4},"end":{"row":170,"column":5},"action":"insert","lines":["/"],"id":3058}],[{"start":{"row":170,"column":5},"end":{"row":170,"column":6},"action":"insert","lines":["/"],"id":3059}],[{"start":{"row":172,"column":5},"end":{"row":172,"column":6},"action":"insert","lines":["/"],"id":3060}],[{"start":{"row":172,"column":6},"end":{"row":172,"column":7},"action":"insert","lines":["/"],"id":3061}],[{"start":{"row":171,"column":4},"end":{"row":171,"column":5},"action":"insert","lines":["/"],"id":3062}],[{"start":{"row":171,"column":5},"end":{"row":171,"column":6},"action":"insert","lines":["/"],"id":3063}],[{"start":{"row":174,"column":4},"end":{"row":174,"column":5},"action":"insert","lines":["/"],"id":3064}],[{"start":{"row":174,"column":5},"end":{"row":174,"column":6},"action":"insert","lines":["/"],"id":3065}],[{"start":{"row":175,"column":4},"end":{"row":175,"column":5},"action":"insert","lines":["/"],"id":3066}],[{"start":{"row":175,"column":5},"end":{"row":175,"column":6},"action":"insert","lines":["/"],"id":3067}],[{"start":{"row":152,"column":4},"end":{"row":152,"column":5},"action":"remove","lines":["/"],"id":3068}],[{"start":{"row":152,"column":3},"end":{"row":152,"column":4},"action":"remove","lines":["/"],"id":3069}],[{"start":{"row":153,"column":4},"end":{"row":153,"column":5},"action":"remove","lines":["/"],"id":3070}],[{"start":{"row":153,"column":3},"end":{"row":153,"column":4},"action":"remove","lines":["/"],"id":3071}],[{"start":{"row":153,"column":2},"end":{"row":153,"column":3},"action":"remove","lines":[" "],"id":3072}],[{"start":{"row":154,"column":3},"end":{"row":154,"column":4},"action":"remove","lines":["/"],"id":3073}],[{"start":{"row":154,"column":2},"end":{"row":154,"column":3},"action":"remove","lines":["/"],"id":3074}],[{"start":{"row":155,"column":3},"end":{"row":155,"column":4},"action":"remove","lines":["/"],"id":3075}],[{"start":{"row":155,"column":2},"end":{"row":155,"column":3},"action":"remove","lines":["/"],"id":3076}],[{"start":{"row":153,"column":7},"end":{"row":153,"column":8},"action":"insert","lines":[" "],"id":3077}],[{"start":{"row":152,"column":8},"end":{"row":152,"column":9},"action":"insert","lines":["v"],"id":3078}],[{"start":{"row":152,"column":9},"end":{"row":152,"column":10},"action":"insert","lines":["m"],"id":3079}],[{"start":{"row":152,"column":10},"end":{"row":152,"column":11},"action":"insert","lines":[" "],"id":3080}],[{"start":{"row":152,"column":11},"end":{"row":152,"column":12},"action":"insert","lines":["-"],"id":3081}],[{"start":{"row":152,"column":12},"end":{"row":152,"column":13},"action":"insert","lines":[">"],"id":3082}],[{"start":{"row":152,"column":10},"end":{"row":152,"column":11},"action":"remove","lines":[" "],"id":3083}],[{"start":{"row":152,"column":34},"end":{"row":152,"column":35},"action":"remove","lines":["&"],"id":3084}],[{"start":{"row":152,"column":38},"end":{"row":152,"column":39},"action":"remove","lines":["&"],"id":3085}],[{"start":{"row":152,"column":11},"end":{"row":152,"column":12},"action":"remove","lines":[">"],"id":3086}],[{"start":{"row":152,"column":10},"end":{"row":152,"column":11},"action":"remove","lines":["-"],"id":3087}],[{"start":{"row":152,"column":9},"end":{"row":152,"column":10},"action":"remove","lines":["m"],"id":3088}],[{"start":{"row":152,"column":8},"end":{"row":152,"column":9},"action":"remove","lines":["v"],"id":3089}],[{"start":{"row":152,"column":30},"end":{"row":152,"column":31},"action":"insert","lines":["&"],"id":3090}],[{"start":{"row":152,"column":35},"end":{"row":152,"column":36},"action":"insert","lines":["&"],"id":3093}],[{"start":{"row":152,"column":35},"end":{"row":152,"column":36},"action":"remove","lines":["&"],"id":3094}],[{"start":{"row":152,"column":30},"end":{"row":152,"column":31},"action":"remove","lines":["&"],"id":3095}],[{"start":{"row":152,"column":30},"end":{"row":152,"column":31},"action":"insert","lines":["&"],"id":3096}],[{"start":{"row":152,"column":30},"end":{"row":152,"column":31},"action":"remove","lines":["&"],"id":3097}],[{"start":{"row":153,"column":16},"end":{"row":153,"column":22},"action":"remove","lines":["Dalvik"],"id":3098},{"start":{"row":153,"column":16},"end":{"row":153,"column":17},"action":"insert","lines":["S"]}],[{"start":{"row":153,"column":17},"end":{"row":153,"column":18},"action":"insert","lines":["c"],"id":3099}],[{"start":{"row":153,"column":18},"end":{"row":153,"column":19},"action":"insert","lines":["o"],"id":3100}],[{"start":{"row":153,"column":19},"end":{"row":153,"column":20},"action":"insert","lines":["r"],"id":3101}],[{"start":{"row":153,"column":20},"end":{"row":153,"column":21},"action":"insert","lines":["p"],"id":3102}],[{"start":{"row":153,"column":21},"end":{"row":153,"column":22},"action":"insert","lines":["i"],"id":3103}],[{"start":{"row":153,"column":22},"end":{"row":153,"column":23},"action":"insert","lines":["o"],"id":3104}],[{"start":{"row":153,"column":23},"end":{"row":153,"column":24},"action":"insert","lines":["n"],"id":3105}],[{"start":{"row":152,"column":40},"end":{"row":152,"column":41},"action":"remove","lines":["<"],"id":3106}],[{"start":{"row":152,"column":40},"end":{"row":152,"column":41},"action":"insert","lines":["!"],"id":3107}],[{"start":{"row":152,"column":41},"end":{"row":152,"column":42},"action":"insert","lines":["="],"id":3108}]]},"ace":{"folds":[],"scrolltop":2400.5,"scrollleft":0,"selection":{"start":{"row":164,"column":21},"end":{"row":164,"column":21},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":140,"state":"start","mode":"ace/mode/c_cpp"}},"timestamp":1442001019655}